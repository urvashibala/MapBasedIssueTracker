generator client {
  provider      = "prisma-client"
  output        = "../src/generated/prisma"
  binaryTargets = ["native", "windows", "darwin-arm64"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              Int                   @id @default(autoincrement())
  email           String                @unique
  password        String
  name            String?
  createdAt       DateTime              @default(now())
  role            UserRole              @default(USER)
  isBanned        Boolean               @default(false)
  banExpiresAt    DateTime?
  banReason       String?
  credibility     Int                   @default(0)
  picture         String?
  emailVerified   Boolean               @default(false)
  comments        Comment[]
  commentUpvotes  CommentUpvote[]
  issues          Issue[]
  resolutionVotes IssueResolutionVote[]
  issueUpvotes    IssueUpvote[]
  notifications   Notification[]
  badges          UserBadge[]
}

model UserBadge {
  id        Int      @id @default(autoincrement())
  name      String
  awardedAt DateTime @default(now())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
}

model GuestToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  createdAt DateTime @default(now())
  issues    Issue[]
}

model Issue {
  id              Int                      @id @default(autoincrement())
  title           String
  description     String
  latitude        Float
  longitude       Float
  status          IssueStatus              @default(PENDING)
  authorized      IssueAuthorized          @default(FALSE)
  error           IssueError               @default(PENDING)
  createdAt       DateTime                 @default(now())
  imageBlobId     String?
  userId          Int
  guestTokenId    Int?
  issueType       IssueType
  severity        Int?
  updatedAt       DateTime                 @default(now()) @updatedAt
  location        Unsupported("geometry")?
  comments        Comment[]
  guestToken      GuestToken?              @relation(fields: [guestTokenId], references: [id])
  user            User                     @relation(fields: [userId], references: [id])
  resolutionVotes IssueResolutionVote[]
  upvotes         IssueUpvote[]

  @@index([issueType])
  @@index([userId])
  @@index([latitude, longitude])
  @@index([location], map: "issue_location_idx", type: Gist)
}

model IssueUpvote {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  issueId   Int
  userId    Int
  issue     Issue    @relation(fields: [issueId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([issueId, userId])
}

model IssueResolutionVote {
  id         Int      @id @default(autoincrement())
  createdAt  DateTime @default(now())
  isResolved Boolean
  issueId    Int
  userId     Int
  issue      Issue    @relation(fields: [issueId], references: [id])
  user       User     @relation(fields: [userId], references: [id])

  @@unique([issueId, userId])
}

model Comment {
  id                Int             @id @default(autoincrement())
  content           String
  createdAt         DateTime        @default(now())
  issueId           Int
  userId            Int
  isFlagged         Boolean         @default(false)
  flaggedReason     String?
  isSystemGenerated Boolean         @default(false)
  issue             Issue           @relation(fields: [issueId], references: [id])
  user              User            @relation(fields: [userId], references: [id])
  upvotes           CommentUpvote[]
}

model CommentUpvote {
  id        Int      @id @default(autoincrement())
  commentId Int
  userId    Int
  createdAt DateTime @default(now())
  comment   Comment  @relation(fields: [commentId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([commentId, userId])
}

model Notification {
  id        Int              @id @default(autoincrement())
  type      NotificationType @default(GENERAL)
  message   String
  createdAt DateTime         @default(now())
  read      Boolean          @default(false)
  userId    Int?
  user      User?            @relation(fields: [userId], references: [id])
}

model GraphNode {
  id        String                   @id @default(uuid())
  osmId     String                   @unique
  latitude  Float
  longitude Float
  location  Unsupported("geometry(Point, 4326)")?
  incoming  GraphEdge[]              @relation("EndNode")
  outgoing  GraphEdge[]              @relation("StartNode")

  @@index([latitude, longitude])
  @@index([location], type: Gist)
}

model GraphEdge {
  id          String    @id @default(uuid())
  startNodeId String
  endNodeId   String
  distance    Float
  baseCost    Float
  penalty     Float     @default(1.0)
  endNode     GraphNode @relation("EndNode", fields: [endNodeId], references: [id])
  startNode   GraphNode @relation("StartNode", fields: [startNodeId], references: [id])

  @@index([startNodeId])
  @@index([endNodeId])
}

model playing_with_neon {
  id    Int    @id @default(autoincrement())
  name  String
  value Float? @db.Real
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model spatial_ref_sys {
  srid      Int     @id
  auth_name String? @db.VarChar(256)
  auth_srid Int?
  srtext    String? @db.VarChar(2048)
  proj4text String? @db.VarChar(2048)
}

enum UserRole {
  USER
  ADMIN
  GUEST
  PIGS
}

enum IssueStatus {
  PENDING
  IN_PROGRESS
  RESOLVED
}

enum IssueAuthorized {
  TRUE
  FALSE
}

enum IssueError {
  NONE
  INVALID_LOCATION
  INAPPROPRIATE_CONTENT
  PENDING
}

enum IssueType {
  POTHOLE
  ROAD_DAMAGE
  STREETLIGHT_FAULT
  GARBAGE_UNCOLLECTED
  ILLEGAL_DUMPING
  DRAINAGE_BLOCKED
  SEWAGE_OVERFLOW
  WATER_SUPPLY_ISSUE
  LOW_WATER_PRESSURE
  OPEN_MANHOLE
  BROKEN_FOOTPATH
  ILLEGAL_ENCROACHMENT
  STRAY_CATTLE
  TREE_FALL
  TRAFFIC_LIGHT_FAULT
  MOSQUITO_BREEDING
  NOISE_COMPLAINT
  BUILDING_SAFETY
}

enum NotificationType {
  ISSUE_STATUS_UPDATE
  NEW_COMMENT
  GENERAL
  BAN_NOTICE
  REMOVAL_NOTICE
  UPVOTE_RECEIVED
}
